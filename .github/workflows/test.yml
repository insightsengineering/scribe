name: Test ğŸ§ª

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: test-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test ğŸ”
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version:
          - 1.21.3
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout Repo ğŸ›
        uses: actions/checkout@v3

      - name: Setup Go ğŸ¹
        uses: actions/setup-go@v3
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: go.sum

      - name: Run Tests ğŸ§¨
        run: make test

      - name: Check whether JUnit XML report exists ğŸš¦
        id: check-junit-xml
        uses: andstor/file-existence-action@v1
        with:
          files: junit-report.xml

      - name: Publish Unit Test Summary ğŸ“‘
        uses: EnricoMi/publish-unit-test-result-action@v2
        id: test-results
        if: steps.check-junit-xml.outputs.files_exists == 'true' && github.event_name == 'pull_request'
        with:
          check_name: Unit Tests Summary
          junit_files: junit-report.xml

      - name: Check whether coverage reports exists ğŸ’­
        id: check-coverage-reports
        uses: andstor/file-existence-action@v1
        with:
          files: >-
            coverage.xml,
            coverage.html

      - name: Post coverage report ğŸ—
        if: steps.check-coverage-reports.outputs.files_exists == 'true'
        uses: insightsengineering/coverage-action@v2
        with:
          path: coverage.xml
          threshold: 80
          fail: false
          publish: true
          diff: true
          coverage-reduction-failure: true
          new-uncovered-statements-failure: true
        continue-on-error: true

      - name: Upload report ğŸ”¼
        if: steps.check-coverage-reports.outputs.files_exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage.html
        continue-on-error: true

  compilation:
    name: Build ğŸ—
    strategy:
      matrix:
        go-version:
          - 1.21.3
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo ğŸ›
        uses: actions/checkout@v3

      - name: Setup Go ğŸ¹
        uses: actions/setup-go@v3
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: go.sum

      - name: Check if compilation works ğŸ§±
        run: make build

